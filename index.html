<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Trucking Made Simple — Blueprint (MVP)</title>
<style>
  *, *::before, *::after { box-sizing: border-box; }

  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1020;color:#eef2ff}
  header{position:sticky;top:0;background:#070a14;border-bottom:1px solid #22305e;z-index:10}
  .wrap{max-width:1000px;margin:0 auto;padding:14px}
  h1{font-size:18px;margin:0 0 10px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tabbtn{border:1px solid #22305e;background:#121a33;color:#eef2ff;padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer}
  .tabbtn.active{border-color:#4aa3ff}

  .card{
    background:#121a33;
    border:1px solid #22305e;
    border-radius:16px;
    padding:12px;
    margin-top:12px;
    overflow:hidden;
  }

  label{display:block;font-size:12px;color:#a9b4d0;margin:10px 0 6px}

  input, select, textarea{
    width:100%;
    max-width:100%;
    padding:10px;
    border-radius:12px;
    border:1px solid #22305e;
    background:#0e1530;
    color:#eef2ff;
  }
  textarea{min-height:150px;}

  .grid{display:grid;gap:12px}
  @media(min-width:900px){.grid.cols2{grid-template-columns:1fr 1fr}}

  .row{display:grid;grid-template-columns:1fr;gap:10px}
  @media (min-width: 700px){.row{ grid-template-columns:1fr 1fr; }}

  .actions, .btnrow, .tabs, .toolbar{display:flex;flex-wrap:wrap;gap:10px}

  .btn, .tabbtn{flex:1 1 160px;white-space:normal}

  .btn{border:1px solid #22305e;background:#1a2550;color:#eef2ff;padding:10px 12px;border-radius:12px;font-weight:900;cursor:pointer}
  .btn.primary{background:#1f5bff;border-color:#2b6cff}
  .btn.good{background:#19b56f;border-color:#1ba86a}
  .btn.bad{background:#ff2f58;border-color:#ff2f58}

  .muted{color:#a9b4d0;font-size:13px}
  .kpi{display:flex;justify-content:space-between;gap:10px;padding:10px;border:1px solid #22305e;border-radius:14px;background:#0c1230;margin-top:8px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;white-space:pre-wrap}

  /* Trip page cards stack */
  #tab-trip .grid.cols2 > .card{display:flex;flex-direction:column}
</style>
</head>

<body>
<header><div class="wrap">
  <h1>Trucking Made Simple — Blueprint (Owner-Operator Edition)</h1>
  <div class="tabs">
    <button class="tabbtn active" data-tab="settings" type="button">Settings</button>
    <button class="tabbtn" data-tab="blueprint" type="button">Blueprint</button>
    <button class="tabbtn" data-tab="brokers" type="button">Brokers</button>
    <button class="tabbtn" data-tab="trip" type="button">Trip Entry</button>
    <button class="tabbtn" data-tab="invoices" type="button">Invoices</button>
    <button class="tabbtn" data-tab="profiles" type="button">Shipper/Consignee</button>
  </div>
  <div class="muted" style="margin-top:8px">
    No-Touch Rule: Only <b>Settings</b> is editable. Blueprint/Brokers are read-only outputs. Data saves on this phone (localStorage).
  </div>
</div></header>

<main class="wrap">

<section id="tab-settings" class="tab">
  <div class="grid cols2">
    <div class="card">
      <h2 style="margin:0 0 8px">Mode</h2>
      <label>Fleet Mode (include payroll)</label>
      <select id="fleetMode">
        <option value="false">OFF (Owner-Operator)</option>
        <option value="true">ON (Fleet Mode)</option>
      </select>
      <label>Company driver wage per week (only used when Fleet Mode ON)</label>
      <input id="driverWageWeekly" type="number" step="0.01"/>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Fuel + Time Away</h2>
      <div class="row">
        <div><label>Fuel $/gal</label><input id="fuelPrice" type="number" step="0.001"/></div>
        <div><label>Truck MPG</label><input id="truckMpg" type="number" step="0.01"/></div>
      </div>
      <div class="row">
        <div><label>Hours away per load</label><input id="hoursPerLoad" type="number" step="0.25"/></div>
        <div><label>Days away per load (auto-sync)</label><input id="daysPerLoad" type="number" step="0.01"/></div>
      </div>
      <div class="row">
        <div><label>Avg miles/load (OTR)</label><input id="avgMilesLoadOtr" type="number" step="1"/></div>
        <div><label>Avg miles/load (Local)</label><input id="avgMilesLoadLocal" type="number" step="1"/></div>
      </div>
      <div class="muted" style="margin-top:8px"><b>O.T.R.A.F.F</b> locked: <b>net revenue ÷ hours away from family</b>.</div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Household (Monthly)</h2>
      <div class="row">
        <div><label>House payment</label><input id="hh_house" type="number" step="0.01"/></div>
        <div><label>Utilities</label><input id="hh_util" type="number" step="0.01"/></div>
      </div>
      <div class="row">
        <div><label>Car payment</label><input id="hh_car" type="number" step="0.01"/></div>
        <div><label>Groceries</label><input id="hh_groc" type="number" step="0.01"/></div>
      </div>
      <div class="row">
        <div><label>Car gas (monthly)</label><input id="hh_carGas" type="number" step="0.01"/></div>
        <div><label>Household gas utilities</label><input id="hh_gasUtil" type="number" step="0.01"/></div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Business (Monthly)</h2>
      <div class="row">
        <div><label>Truck payment</label><input id="biz_truck" type="number" step="0.01"/></div>
        <div><label>Trailer payment</label><input id="biz_trailer" type="number" step="0.01"/></div>
      </div>
      <div class="row">
        <div><label>Insurance</label><input id="biz_ins" type="number" step="0.01"/></div>
        <div><label>Business phone</label><input id="biz_phone" type="number" step="0.01"/></div>
      </div>
      <div class="row">
        <div><label>Parking</label><input id="biz_park" type="number" step="0.01"/></div>
        <div><label>ELD</label><input id="biz_eld" type="number" step="0.01"/></div>
      </div>
      <label>Load board</label><input id="biz_lb" type="number" step="0.01"/>
      <div class="muted" style="margin-top:8px">Payroll is handled in Mode (Fleet Mode).</div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <h2 style="margin:0 0 8px">Percent Rules (of Gross) + Annual Caps</h2>
      <div class="muted">Caps are annual; monthly scenario uses cap/12. “Continue after cap” overrides cap.</div>

      <div class="row">
        <div><label>Factoring % (no cap)</label><input id="pct_factoring" type="number" step="0.001"/></div>
        <div><label>Tax reserve % (no cap)</label><input id="pct_tax" type="number" step="0.001"/></div>
      </div>

      <div class="grid cols2">
        <div>
          <label>Plates %</label><input id="pct_plates" type="number" step="0.001"/>
          <label>Plates cap (annual $)</label><input id="cap_plates" type="number" step="0.01"/>
          <label>Continue after cap?</label><select id="aftercap_plates"><option value="false">OFF</option><option value="true">ON</option></select>
        </div>
        <div>
          <label>IFTA %</label><input id="pct_ifta" type="number" step="0.001"/>
          <label>IFTA cap (annual $)</label><input id="cap_ifta" type="number" step="0.01"/>
          <label>Continue after cap?</label><select id="aftercap_ifta"><option value="false">OFF</option><option value="true">ON</option></select>
        </div>
        <div>
          <label>Maintenance %</label><input id="pct_maint" type="number" step="0.001"/>
          <label>Maintenance cap (annual $)</label><input id="cap_maint" type="number" step="0.01"/>
          <label>Continue after cap?</label><select id="aftercap_maint"><option value="false">OFF</option><option value="true">ON</option></select>
        </div>
        <div>
          <label>Heavy highway %</label><input id="pct_hwy" type="number" step="0.001"/>
          <label>Heavy highway cap (annual $)</label><input id="cap_hwy" type="number" step="0.01"/>
          <label>Continue after cap?</label><select id="aftercap_hwy"><option value="false">OFF</option><option value="true">ON</option></select>
        </div>
        <div>
          <label>Tires %</label><input id="pct_tires" type="number" step="0.001"/>
          <label>Tires cap (annual $)</label><input id="cap_tires" type="number" step="0.01"/>
          <label>Continue after cap?</label><select id="aftercap_tires"><option value="false">OFF</option><option value="true">ON</option></select>
        </div>
        <div>
          <label>USDOT %</label><input id="pct_usdot" type="number" step="0.001"/>
          <label>USDOT cap (annual $)</label><input id="cap_usdot" type="number" step="0.01"/>
          <label>Continue after cap?</label><select id="aftercap_usdot"><option value="false">OFF</option><option value="true">ON</option></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div><label>OTR miles per month</label><input id="m_otr" type="number" step="1"/></div>
        <div><label>Local miles per month</label><input id="m_local" type="number" step="1"/></div>
      </div>
      <div class="row">
        <div><label>OTR miles per year</label><input id="y_otr" type="number" step="1"/></div>
        <div><label>Local miles per year</label><input id="y_local" type="number" step="1"/></div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn primary" id="btnResetDefaults" type="button">Reset to Defaults</button>
      </div>
    </div>
  </div>
</section>

<section id="tab-blueprint" class="tab" style="display:none">
  <div class="card">
    <h2 style="margin:0 0 6px">Blueprint (Read-Only)</h2>
    <div class="muted">Minimum sustainable rate per mile for each scenario + O.T.R.A.F.F from saved loads.</div>
    <div id="blueprintOut"></div>
  </div>
</section>

<section id="tab-brokers" class="tab" style="display:none">
  <div class="card">
    <h2 style="margin:0 0 6px">Brokers (Copy/Paste Email)</h2>
    <div class="row">
      <div>
        <label>Scenario</label>
        <select id="brokerScenario">
          <option value="OTR_MONTH">OTR (Monthly)</option>
          <option value="LOCAL_MONTH">Local (Monthly)</option>
          <option value="OTR_YEAR">OTR (Yearly)</option>
          <option value="LOCAL_YEAR">Local (Yearly)</option>
        </select>
      </div>
      <div style="align-self:end">
        <button class="btn good" id="btnCopyBroker" type="button">Copy Email Text</button>
      </div>
    </div>
    <label>Email block</label>
    <textarea id="brokerText" readonly></textarea>
    <div class="muted">This app formats the email. You copy/paste into Gmail/SMS.</div>
  </div>
</section>

<section id="tab-trip" class="tab" style="display:none">
  <div class="grid cols2">
    <div class="card">
      <h2 style="margin:0 0 6px">Trip Entry (per load)</h2>
      <label>Truck #</label><input id="trip_truck" placeholder="Truck 1"/>
      <div class="row">
        <div><label>Deadhead miles</label><input id="trip_deadhead" type="number" step="1"/></div>
        <div><label>Loaded miles</label><input id="trip_loaded" type="number" step="1"/></div>
      </div>
      <div class="row">
        <div><label>Gross revenue ($)</label><input id="trip_gross" type="number" step="0.01"/></div>
        <div><label>Gallons used</label><input id="trip_gallons" type="number" step="0.01"/></div>
      </div>
      <div class="row">
        <div><label>Tolls/misc ($)</label><input id="trip_misc" type="number" step="0.01"/></div>
        <div><label>Hours away (this load)</label><input id="trip_hoursAway" type="number" step="0.25"/></div>
      </div>
      <label>Notes</label><input id="trip_notes" placeholder="lane, broker, etc."/>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn primary" id="btnSaveTrip" type="button">Save Load</button>
        <button class="btn bad" id="btnClearTrips" type="button">Clear All Loads</button>
      </div>
      <div class="kpi"><b>Auto MPG (this load)</b><div id="trip_mpg">—</div></div>
      <div class="kpi"><b>Net revenue (this load)</b><div id="trip_net">—</div></div>
      <div class="kpi"><b>O.T.R.A.F.F (this load)</b><div id="trip_otraff">—</div></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 6px">Load History</h2>
      <label>Search</label><input id="trip_search" placeholder="search notes/truck"/>

      <label>Pick a saved load</label>
      <select id="trip_pickLoad">
        <option value="">— Select a saved load —</option>
      </select>

      <div class="muted" style="margin-top:6px">
        Selecting a load will fill the Trip Entry fields (it won’t change saved history unless you Save Load).
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn" id="btnExportJson" type="button">Copy Trips JSON</button>
      </div>

      <div id="trip_list" style="margin-top:10px"></div>
    </div>
  </div>
</section>

<section id="tab-invoices" class="tab" style="display:none">
  <div class="card">
    <h2 style="margin:0 0 6px">Invoices</h2>
    <div class="muted">Preview pulls everything from the Trip Entry tab (current fields + KPIs + Load History). Print opens a clean printable page.</div>

    <div class="actions" style="margin-top:10px">
      <button class="btn primary" id="btnPreviewInvoice" type="button">Preview</button>
      <button class="btn" id="btnPrintInvoice" type="button">Print</button>
    </div>

    <div id="invoiceOut" style="margin-top:12px"></div>
  </div>
</section>

<section id="tab-profiles" class="tab" style="display:none">
  <div class="grid cols2">
    <div class="card">
      <h2 style="margin:0 0 6px">Shipper Profiles</h2>
      <label>Search as you type</label><input id="shipperSearch" placeholder="name, city, phone..."/>
      <select id="shipperPick" size="6" style="margin-top:10px"></select>
      <div class="row">
        <div><label>Name</label><input id="shipper_name"/></div>
        <div><label>Phone</label><input id="shipper_phone"/></div>
      </div>
      <div class="row">
        <div><label>City</label><input id="shipper_city"/></div>
        <div><label>State</label><input id="shipper_state"/></div>
      </div>
      <label>Address</label><input id="shipper_address"/>
      <div class="row">
        <div><label>Zip</label><input id="shipper_zip"/></div>
        <div><label>Email</label><input id="shipper_email"/></div>
      </div>
      <label>Notes</label><input id="shipper_notes"/>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn good" id="btnSaveShipper" type="button">Save/Update</button>
        <button class="btn bad" id="btnDeleteShipper" type="button">Delete</button>
        <button class="btn" id="btnClearShippers" type="button">Clear All</button>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 6px">Consignee Profiles + Calendar</h2>
      <label>Pickup/Delivery date</label><input id="datePick" type="date"/>
      <label>Search as you type</label><input id="consigneeSearch" placeholder="name, city, phone..."/>
      <select id="consigneePick" size="6" style="margin-top:10px"></select>
      <div class="row">
        <div><label>Name</label><input id="consignee_name"/></div>
        <div><label>Phone</label><input id="consignee_phone"/></div>
      </div>
      <div class="row">
        <div><label>City</label><input id="consignee_city"/></div>
        <div><label>State</label><input id="consignee_state"/></div>
      </div>
      <label>Address</label><input id="consignee_address"/>
      <div class="row">
        <div><label>Zip</label><input id="consignee_zip"/></div>
        <div><label>Email</label><input id="consignee_email"/></div>
      </div>
      <label>Notes</label><input id="consignee_notes"/>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn good" id="btnSaveConsignee" type="button">Save/Update</button>
        <button class="btn bad" id="btnDeleteConsignee" type="button">Delete</button>
        <button class="btn" id="btnClearConsignees" type="button">Clear All</button>
      </div>
    </div>
  </div>
</section>

</main>

<script><script>
(() => {
  const KEY_SETTINGS="tms_settings_v1";
  const KEY_TRIPS="tms_trips_v1";
  const KEY_SHIPPERS="tms_shippers_v1";
  const KEY_CONSIGNEES="tms_consignee_v1";

  const DEFAULTS={
    fleetMode:false, driverWageWeekly:1000,
    fuelPrice:3.659, truckMpg:4.60,
    hoursPerLoad:48, daysPerLoad:2,
    avgMilesLoadOtr:600, avgMilesLoadLocal:250,
    household:{house:1500, util:500, car:500, groc:700, carGas:0, gasUtil:400},
    business:{truck:1500, trailer:1100, ins:1500, phone:150, park:300, eld:25, lb:169},
    pct:{factoring:0.02, tax:0.28, plates:0.05, ifta:0.05, maint:0.07, hwy:0.02, tires:0.05, usdot:0.02},
    cap:{plates:2500, ifta:2500, maint:5000, hwy:550, tires:5000, usdot:150},
    afterCap:{plates:false, ifta:false, maint:false, hwy:false, tires:false, usdot:false},
    miles:{otrMonth:12500, localMonth:6000, otrYear:144000, localYear:72000}
  };

  const $ = (id) => document.getElementById(id);
  const num = (v) => Number(v || 0);
  const money = (n) => Number(n||0).toLocaleString(undefined,{style:"currency",currency:"USD"});

  const clone = (obj) => {
    if (typeof structuredClone === "function") return structuredClone(obj);
    return JSON.parse(JSON.stringify(obj));
  };

  const makeId = () => {
    try{
      if (crypto && typeof crypto.randomUUID === "function") return crypto.randomUUID();
      if (crypto && crypto.getRandomValues){
        const bytes = new Uint8Array(16);
        crypto.getRandomValues(bytes);
        bytes[6] = (bytes[6] & 0x0f) | 0x40;
        bytes[8] = (bytes[8] & 0x3f) | 0x80;
        const hex = [...bytes].map(b => b.toString(16).padStart(2,"0"));
        return `${hex.slice(0,4).join("")}-${hex.slice(4,6).join("")}-${hex.slice(6,8).join("")}-${hex.slice(8,10).join("")}-${hex.slice(10,16).join("")}`;
      }
    }catch{}
    return String(Date.now()) + "_" + Math.random().toString(16).slice(2);
  };

  const bind = (id, evt, fn) => {
    const el = $(id);
    if (!el) return;
    el.addEventListener(evt, fn);
  };

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function loadJSON(key, fallback){
    try{
      const r = localStorage.getItem(key);
      return r ? JSON.parse(r) : fallback;
    }catch{
      return fallback;
    }
  }
  function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

  function getTrips(){ return loadJSON(KEY_TRIPS, []); }
  function saveTrips(list){ saveJSON(KEY_TRIPS, list); }

  function getShippers(){ return loadJSON(KEY_SHIPPERS, []); }
  function saveShippers(list){ saveJSON(KEY_SHIPPERS, list); }

  function getConsignees(){ return loadJSON(KEY_CONSIGNEES, []); }
  function saveConsignees(list){ saveJSON(KEY_CONSIGNEES, list); }

  function getSettings(){
    const s={
      fleetMode: $("fleetMode").value==="true",
      driverWageWeekly: num($("driverWageWeekly").value),
      fuelPrice: num($("fuelPrice").value),
      truckMpg: num($("truckMpg").value) || DEFAULTS.truckMpg,
      hoursPerLoad: num($("hoursPerLoad").value),
      daysPerLoad: num($("daysPerLoad").value),
      avgMilesLoadOtr: num($("avgMilesLoadOtr").value),
      avgMilesLoadLocal: num($("avgMilesLoadLocal").value),
      household:{
        house:num($("hh_house").value), util:num($("hh_util").value), car:num($("hh_car").value),
        groc:num($("hh_groc").value), carGas:num($("hh_carGas").value), gasUtil:num($("hh_gasUtil").value)
      },
      business:{
        truck:num($("biz_truck").value), trailer:num($("biz_trailer").value), ins:num($("biz_ins").value),
        phone:num($("biz_phone").value), park:num($("biz_park").value), eld:num($("biz_eld").value), lb:num($("biz_lb").value)
      },
      pct:{
        factoring:num($("pct_factoring").value), tax:num($("pct_tax").value),
        plates:num($("pct_plates").value), ifta:num($("pct_ifta").value), maint:num($("pct_maint").value),
        hwy:num($("pct_hwy").value), tires:num($("pct_tires").value), usdot:num($("pct_usdot").value)
      },
      cap:{
        plates:num($("cap_plates").value), ifta:num($("cap_ifta").value), maint:num($("cap_maint").value),
        hwy:num($("cap_hwy").value), tires:num($("cap_tires").value), usdot:num($("cap_usdot").value)
      },
      afterCap:{
        plates:$("aftercap_plates").value==="true", ifta:$("aftercap_ifta").value==="true",
        maint:$("aftercap_maint").value==="true", hwy:$("aftercap_hwy").value==="true",
        tires:$("aftercap_tires").value==="true", usdot:$("aftercap_usdot").value==="true"
      },
      miles:{
        otrMonth:num($("m_otr").value), localMonth:num($("m_local").value),
        otrYear:num($("y_otr").value), localYear:num($("y_local").value)
      }
    };

    // sync hours/days
    if(s.hoursPerLoad>0) s.daysPerLoad = s.hoursPerLoad/24;
    if(s.daysPerLoad>0 && s.hoursPerLoad<=0) s.hoursPerLoad = s.daysPerLoad*24;
    return s;
  }

  function setSettings(s){
    $("fleetMode").value=String(!!s.fleetMode);
    $("driverWageWeekly").value=s.driverWageWeekly;

    $("fuelPrice").value=s.fuelPrice;
    $("truckMpg").value=s.truckMpg;

    $("hoursPerLoad").value=s.hoursPerLoad;
    $("daysPerLoad").value=s.daysPerLoad;

    $("avgMilesLoadOtr").value=s.avgMilesLoadOtr;
    $("avgMilesLoadLocal").value=s.avgMilesLoadLocal;

    $("hh_house").value=s.household.house; $("hh_util").value=s.household.util;
    $("hh_car").value=s.household.car; $("hh_groc").value=s.household.groc;
    $("hh_carGas").value=s.household.carGas; $("hh_gasUtil").value=s.household.gasUtil;

    $("biz_truck").value=s.business.truck; $("biz_trailer").value=s.business.trailer;
    $("biz_ins").value=s.business.ins; $("biz_phone").value=s.business.phone;
    $("biz_park").value=s.business.park; $("biz_eld").value=s.business.eld; $("biz_lb").value=s.business.lb;

    $("pct_factoring").value=s.pct.factoring; $("pct_tax").value=s.pct.tax;
    $("pct_plates").value=s.pct.plates; $("cap_plates").value=s.cap.plates; $("aftercap_plates").value=String(!!s.afterCap.plates);
    $("pct_ifta").value=s.pct.ifta; $("cap_ifta").value=s.cap.ifta; $("aftercap_ifta").value=String(!!s.afterCap.ifta);
    $("pct_maint").value=s.pct.maint; $("cap_maint").value=s.cap.maint; $("aftercap_maint").value=String(!!s.afterCap.maint);
    $("pct_hwy").value=s.pct.hwy; $("cap_hwy").value=s.cap.hwy; $("aftercap_hwy").value=String(!!s.afterCap.hwy);
    $("pct_tires").value=s.pct.tires; $("cap_tires").value=s.cap.tires; $("aftercap_tires").value=String(!!s.afterCap.tires);
    $("pct_usdot").value=s.pct.usdot; $("cap_usdot").value=s.cap.usdot; $("aftercap_usdot").value=String(!!s.afterCap.usdot);

    $("m_otr").value=s.miles.otrMonth; $("m_local").value=s.miles.localMonth;
    $("y_otr").value=s.miles.otrYear; $("y_local").value=s.miles.localYear;
  }

  function persistSettings(){
    saveJSON(KEY_SETTINGS, getSettings());
    refreshAll();
  }

  function monthlyTotals(s){
    const hh=Object.values(s.household).reduce((a,b)=>a+num(b),0);
    let biz=Object.values(s.business).reduce((a,b)=>a+num(b),0);
    if(s.fleetMode) biz += num(s.driverWageWeekly)*52/12;
    return {hh,biz};
  }

  function fuelCostForMiles(s,miles){ return (miles/Math.max(0.01,s.truckMpg))*s.fuelPrice; }
  function capForPeriod(annualCap, period){ return period==="year"?annualCap:annualCap/12; }
  function cappedAmt(gross,p,capAnnual,period,after){
    const raw=gross*p;
    const cap=capForPeriod(capAnnual,period);
    return after?raw:Math.min(raw,cap);
  }

  function solveGrossRequired(s,miles,period){
    const {hh,biz}=monthlyTotals(s);
    const fixed=(period==="year")?(hh+biz)*12:(hh+biz);
    const fuel=fuelCostForMiles(s,miles);
    let gross=(fixed+fuel)/Math.max(0.01,(1-(s.pct.factoring+s.pct.tax+s.pct.plates+s.pct.ifta+s.pct.maint+s.pct.hwy+s.pct.tires+s.pct.usdot)));

    for(let i=0;i<60;i++){
      const factoring=gross*s.pct.factoring;
      const tax=gross*s.pct.tax;
      const plates=cappedAmt(gross,s.pct.plates,s.cap.plates,period,s.afterCap.plates);
      const ifta=cappedAmt(gross,s.pct.ifta,s.cap.ifta,period,s.afterCap.ifta);
      const maint=cappedAmt(gross,s.pct.maint,s.cap.maint,period,s.afterCap.maint);
      const hwy=cappedAmt(gross,s.pct.hwy,s.cap.hwy,period,s.afterCap.hwy);
      const tires=cappedAmt(gross,s.pct.tires,s.cap.tires,period,s.afterCap.tires);
      const usdot=cappedAmt(gross,s.pct.usdot,s.cap.usdot,period,s.afterCap.usdot);
      const next=fixed+fuel+factoring+tax+plates+ifta+maint+hwy+tires+usdot;
      if(Math.abs(next-gross)<1e-6*Math.max(1,gross)){gross=next;break}
      gross=next;
    }

    const r={period,miles,fixed,fuel,gross,rpm:gross/Math.max(1,miles)};
    r.factoring=gross*s.pct.factoring; r.tax=gross*s.pct.tax;
    r.plates=cappedAmt(gross,s.pct.plates,s.cap.plates,period,s.afterCap.plates);
    r.ifta=cappedAmt(gross,s.pct.ifta,s.cap.ifta,period,s.afterCap.ifta);
    r.maint=cappedAmt(gross,s.pct.maint,s.cap.maint,period,s.afterCap.maint);
    r.hwy=cappedAmt(gross,s.pct.hwy,s.cap.hwy,period,s.afterCap.hwy);
    r.tires=cappedAmt(gross,s.pct.tires,s.cap.tires,period,s.afterCap.tires);
    r.usdot=cappedAmt(gross,s.pct.usdot,s.cap.usdot,period,s.afterCap.usdot);
    return r;
  }

  function calcTripNet(s, t){
    const miles=num(t.deadhead)+num(t.loaded);
    const gross=num(t.gross);
    const gallons=num(t.gallons);
    const misc=num(t.misc);
    const fuel = gallons>0 ? gallons*s.fuelPrice : fuelCostForMiles(s,miles);

    const net = gross - (
      fuel + misc +
      gross*s.pct.factoring + gross*s.pct.tax +
      gross*s.pct.plates + gross*s.pct.ifta + gross*s.pct.maint +
      gross*s.pct.hwy + gross*s.pct.tires + gross*s.pct.usdot
    );
    return {miles,gross,fuel,net,misc};
  }

  function previewTrip(){
    const s=getSettings();
    const t={
      deadhead:num($("trip_deadhead").value), loaded:num($("trip_loaded").value),
      gross:num($("trip_gross").value), gallons:num($("trip_gallons").value),
      misc:num($("trip_misc").value), hoursAway:num($("trip_hoursAway").value)
    };
    const miles=t.deadhead+t.loaded;
    const mpg=t.gallons>0 ? miles/t.gallons : 0;
    const {net}=calcTripNet(s,t);
    const otraf = t.hoursAway>0 ? net/t.hoursAway : 0;
    $("trip_mpg").textContent = mpg>0 ? mpg.toFixed(2) : "—";
    $("trip_net").textContent = money(net);
    $("trip_otraff").textContent = t.hoursAway>0 ? money(otraf)+"/hr" : "—";
  }

  function fillTripEntryFromLoad(t){
    $("trip_truck").value = t.truck || "";
    $("trip_deadhead").value = Number(t.deadhead||0);
    $("trip_loaded").value = Number(t.loaded||0);
    $("trip_gross").value = Number(t.gross||0);
    $("trip_gallons").value = Number(t.gallons||0);
    $("trip_misc").value = Number(t.misc||0);
    $("trip_hoursAway").value = Number(t.hoursAway||0);
    $("trip_notes").value = t.notes || "";
    previewTrip();
  }

  function refreshTripsDropdown(){
    const trips = getTrips();
    const sel = $("trip_pickLoad");
    if(!sel) return;
    sel.innerHTML = `<option value="">— Select a saved load —</option>` +
      trips.slice(0,200).map(t=>{
        const when = new Date(t.ts).toLocaleString();
        const label = `${t.truck || "Truck"} • ${when} • $${Number(t.gross||0).toFixed(0)} • ${Number(t.loaded||0).toFixed(0)}mi`;
        return `<option value="${esc(t.id)}">${esc(label)}</option>`;
      }).join("");
  }

  function refreshTripsList(){
    const q=($("trip_search")?.value||"").toLowerCase().trim();
    const s=getSettings();
    const list=getTrips().filter(t=>{
      if(!q) return true;
      const hay=`${t.truck||""} ${t.notes||""} ${t.ts||""}`.toLowerCase();
      return hay.includes(q);
    }).slice(0,50);

    const box=$("trip_list");
    if(!box) return;
    if(!list.length){ box.innerHTML='<div class="muted">No saved loads yet.</div>'; return; }

    box.innerHTML = list.map(t=>{
      const calc=calcTripNet(s,t);
      const otraf = num(t.hoursAway)>0 ? calc.net/num(t.hoursAway) : 0;
      return `<div class="kpi"><div>
        <b>${esc(t.truck || "Truck")}</b><div class="muted">${new Date(t.ts).toLocaleString()} • Miles ${calc.miles.toFixed(0)} • Gross ${money(calc.gross)}</div>
        <div class="muted">${esc(t.notes||"")}</div>
      </div><div><b>${money(calc.net)}</b><div class="muted">OTRAFF ${num(t.hoursAway)>0?money(otraf)+"/hr":"—"}</div></div></div>`;
    }).join("");
  }

  function avgOTRAFFFromSavedTrips(){
    const s = getSettings();
    const trips = getTrips();
    let totalNet=0, totalHours=0;
    for(const t of trips){
      const calc = calcTripNet(s,t);
      const h = num(t.hoursAway);
      if(h>0){
        totalNet += calc.net;
        totalHours += h;
      }
    }
    return totalHours>0 ? (totalNet/totalHours) : 0;
  }

  // Clipboard helper (because browsers are dramatic)
  async function copyText(txt){
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(txt);
        return true;
      }
    }catch{}
    try{
      const ta=document.createElement("textarea");
      ta.value=txt;
      ta.style.position="fixed";
      ta.style.left="-9999px";
      ta.style.top="0";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      const ok=document.execCommand("copy");
      ta.remove();
      return ok;
    }catch{
      return false;
    }
  }

  // ---------- BLUEPRINT ----------
  function renderBlueprint(){
    const out = $("blueprintOut");
    if(!out) return;

    const s=getSettings();
    const otrM = solveGrossRequired(s, s.miles.otrMonth, "month");
    const locM = solveGrossRequired(s, s.miles.localMonth, "month");
    const otrY = solveGrossRequired(s, s.miles.otrYear, "year");
    const locY = solveGrossRequired(s, s.miles.localYear, "year");

    const otraf = avgOTRAFFFromSavedTrips();

    const block = (title, r) => `
      <div class="card" style="margin-top:10px">
        <b>${esc(title)}</b>
        <div class="kpi"><span>Minimum Gross Required</span><b>${money(r.gross)}</b></div>
        <div class="kpi"><span>Minimum Rate / Mile</span><b>${money(r.rpm)}/mi</b></div>
        <div class="muted" style="margin-top:8px">Assumptions: ${r.miles.toLocaleString()} miles (${r.period}). Fixed: ${money(r.fixed)} • Fuel: ${money(r.fuel)}</div>
        <details style="margin-top:8px">
          <summary class="muted" style="cursor:pointer">Show breakdown</summary>
          <div class="mono" style="margin-top:8px">
factoring: ${money(r.factoring)}
tax:       ${money(r.tax)}
plates:    ${money(r.plates)}
ifta:      ${money(r.ifta)}
maint:     ${money(r.maint)}
hwy:       ${money(r.hwy)}
tires:     ${money(r.tires)}
usdot:     ${money(r.usdot)}
          </div>
        </details>
      </div>
    `;

    out.innerHTML = `
      <div class="kpi"><span><b>Saved-load O.T.R.A.F.F</b> (net ÷ hours away)</span><b>${otraf>0?money(otraf)+"/hr":"—"}</b></div>
      ${block("OTR (Monthly)", otrM)}
      ${block("Local (Monthly)", locM)}
      ${block("OTR (Yearly)", otrY)}
      ${block("Local (Yearly)", locY)}
    `;

    // also refresh broker text if brokers tab exists
    renderBrokerEmail();
  }

  function getBlueprintScenario(scn){
    const s=getSettings();
    if(scn==="OTR_MONTH") return {label:"OTR (Monthly)", r:solveGrossRequired(s, s.miles.otrMonth, "month")};
    if(scn==="LOCAL_MONTH") return {label:"Local (Monthly)", r:solveGrossRequired(s, s.miles.localMonth, "month")};
    if(scn==="OTR_YEAR") return {label:"OTR (Yearly)", r:solveGrossRequired(s, s.miles.otrYear, "year")};
    return {label:"Local (Yearly)", r:solveGrossRequired(s, s.miles.localYear, "year")};
  }

  // ---------- BROKERS ----------
  function renderBrokerEmail(){
    const ta = $("brokerText");
    const sel = $("brokerScenario");
    if(!ta || !sel) return;

    const {label, r} = getBlueprintScenario(sel.value);
    const rpm = r.rpm;

    const s=getSettings();
    const notes = [
      `Fuel: $${Number(s.fuelPrice||0).toFixed(3)}/gal • MPG: ${Number(s.truckMpg||0).toFixed(2)}`,
      `This quote reflects my minimum sustainable operating rate for the lane.`,
      `Please advise if you can meet or beat ${money(rpm)}/mi all-in (linehaul + FSC).`
    ].join("\n");

    const text =
`Subject: Rate Request / Quote

Hello,

I’m available for this lane. Based on my operating costs, my minimum sustainable rate is:

• Scenario: ${label}
• Minimum all-in rate: ${money(rpm)}/mile
• Minimum gross required (${r.period}): ${money(r.gross)}

${notes}

Thank you,
[Your Name]
[MC/DOT]
[Phone]`;

    ta.value = text;
  }

  // ---------- TRIPS SAVE / CLEAR / EXPORT ----------
  function saveTrip(){
    const t = {
      id: makeId(),
      ts: Date.now(),
      truck: ($("trip_truck")?.value||"").trim() || "Truck",
      deadhead: num($("trip_deadhead")?.value),
      loaded: num($("trip_loaded")?.value),
      gross: num($("trip_gross")?.value),
      gallons: num($("trip_gallons")?.value),
      misc: num($("trip_misc")?.value),
      hoursAway: num($("trip_hoursAway")?.value),
      notes: ($("trip_notes")?.value||"").trim()
    };
    const trips = getTrips();
    trips.unshift(t);
    saveTrips(trips);
    refreshAll();
  }

  function clearTrips(){
    const ok = confirm("Clear ALL saved loads? This cannot be undone.");
    if(!ok) return;
    saveTrips([]);
    refreshAll();
  }

  async function exportTripsJson(){
    const txt = JSON.stringify(getTrips(), null, 2);
    const ok = await copyText(txt);
    alert(ok ? "Trips JSON copied to clipboard." : "Could not copy. (Your browser is being difficult.)");
  }

  // ---------- INVOICES ----------
  function buildTripsHtmlForInvoice(){
    const s = getSettings();
    const trips = getTrips();

    const current = {
      truck: ($("trip_truck")?.value||"").trim() || "",
      deadhead: num($("trip_deadhead")?.value),
      loaded: num($("trip_loaded")?.value),
      gross: num($("trip_gross")?.value),
      gallons: num($("trip_gallons")?.value),
      misc: num($("trip_misc")?.value),
      hoursAway: num($("trip_hoursAway")?.value),
      notes: ($("trip_notes")?.value||"").trim() || ""
    };

    const milesCur = current.deadhead + current.loaded;
    const mpgCur = current.gallons>0 ? (milesCur/current.gallons) : 0;
    const calcCur = calcTripNet(s, current);
    const otrafCur = current.hoursAway>0 ? (calcCur.net/current.hoursAway) : 0;

    // Summary of saved loads
    let sumMiles=0, sumGross=0, sumNet=0, sumHours=0;
    for(const t of trips){
      const c = calcTripNet(s,t);
      sumMiles += c.miles;
      sumGross += c.gross;
      sumNet += c.net;
      sumHours += num(t.hoursAway);
    }
    const otrafAll = sumHours>0 ? (sumNet/sumHours) : 0;

    const tableRows = trips.slice(0,30).map(t=>{
      const c = calcTripNet(s,t);
      const otr = num(t.hoursAway)>0 ? (c.net/num(t.hoursAway)) : 0;
      return `
        <tr>
          <td>${esc(new Date(t.ts).toLocaleDateString())}</td>
          <td>${esc(t.truck||"")}</td>
          <td style="text-align:right">${c.miles.toFixed(0)}</td>
          <td style="text-align:right">${money(c.gross)}</td>
          <td style="text-align:right">${money(c.net)}</td>
          <td style="text-align:right">${num(t.hoursAway)>0?money(otr)+"/hr":"—"}</td>
          <td>${esc(t.notes||"")}</td>
        </tr>
      `;
    }).join("");

    return `
      <div class="card">
        <h3 style="margin:0 0 8px">Current Load (from Trip Entry)</h3>
        <div class="kpi"><b>Truck</b><div>${esc(current.truck||"—")}</div></div>
        <div class="kpi"><b>Miles (deadhead + loaded)</b><div>${milesCur>0?milesCur.toFixed(0):"—"}</div></div>
        <div class="kpi"><b>Gross</b><div>${money(current.gross)}</div></div>
        <div class="kpi"><b>Fuel</b><div>${money(calcCur.fuel)}</div></div>
        <div class="kpi"><b>Misc/Tolls</b><div>${money(calcCur.misc)}</div></div>
        <div class="kpi"><b>Net</b><div>${money(calcCur.net)}</div></div>
        <div class="kpi"><b>MPG</b><div>${mpgCur>0?mpgCur.toFixed(2):"—"}</div></div>
        <div class="kpi"><b>O.T.R.A.F.F</b><div>${current.hoursAway>0?money(otrafCur)+"/hr":"—"}</div></div>
        <div class="muted" style="margin-top:8px">${esc(current.notes||"")}</div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px">Saved Loads Summary</h3>
        <div class="kpi"><b>Loads saved</b><div>${trips.length}</div></div>
        <div class="kpi"><b>Total miles</b><div>${sumMiles.toFixed(0)}</div></div>
        <div class="kpi"><b>Total gross</b><div>${money(sumGross)}</div></div>
        <div class="kpi"><b>Total net</b><div>${money(sumNet)}</div></div>
        <div class="kpi"><b>Average O.T.R.A.F.F</b><div>${sumHours>0?money(otrafAll)+"/hr":"—"}</div></div>

        <div style="overflow:auto;margin-top:10px">
          <table style="width:100%;border-collapse:collapse;font-size:12px">
            <thead>
              <tr style="text-align:left;border-bottom:1px solid #22305e">
                <th style="padding:8px">Date</th>
                <th style="padding:8px">Truck</th>
                <th style="padding:8px;text-align:right">Miles</th>
                <th style="padding:8px;text-align:right">Gross</th>
                <th style="padding:8px;text-align:right">Net</th>
                <th style="padding:8px;text-align:right">OTRAFF</th>
                <th style="padding:8px">Notes</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows || `<tr><td colspan="7" class="muted" style="padding:10px">No saved loads yet.</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  function previewInvoice(){
    const out = $("invoiceOut");
    if(!out) return;
    out.innerHTML = buildTripsHtmlForInvoice();
  }

  function printInvoice(){
    const html = buildTripsHtmlForInvoice();
    const w = window.open("", "_blank");
    if(!w){ alert("Popup blocked. Allow popups to print."); return; }

    w.document.open();
    w.document.write(`
<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Invoice Print</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:20px;color:#111}
  .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin-bottom:12px}
  .kpi{display:flex;justify-content:space-between;gap:10px;padding:8px;border:1px solid #eee;border-radius:10px;margin-top:8px}
  .muted{color:#666;font-size:12px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #eee;padding:8px;vertical-align:top}
  th{background:#fafafa}
  @media print{ button{display:none} }
</style>
</head>
<body>
  <button onclick="window.print()" style="padding:10px 12px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer">Print</button>
  <div style="height:10px"></div>
  ${html}
</body>
</html>
    `);
    w.document.close();
  }

  // ---------- PROFILES ----------
  function refreshProfilePick(kind){
    const list = kind==="shipper" ? getShippers() : getConsignees();
    const pick = $(kind==="shipper" ? "shipperPick" : "consigneePick");
    const q = ($(kind==="shipper" ? "shipperSearch" : "consigneeSearch")?.value || "").toLowerCase().trim();
    if(!pick) return;

    const filtered = list.filter(p=>{
      if(!q) return true;
      const hay = `${p.name||""} ${p.city||""} ${p.state||""} ${p.phone||""} ${p.email||""} ${p.address||""} ${p.zip||""} ${p.notes||""}`.toLowerCase();
      return hay.includes(q);
    });

    pick.innerHTML = filtered.slice(0,200).map(p=>{
      const label = `${p.name||"—"} • ${p.city||""} ${p.state||""}`.trim();
      return `<option value="${esc(p.id)}">${esc(label)}</option>`;
    }).join("");
  }

  function getProfileFields(kind){
    const prefix = kind==="shipper" ? "shipper_" : "consignee_";
    return {
      name: ($(prefix+"name")?.value||"").trim(),
      phone: ($(prefix+"phone")?.value||"").trim(),
      city: ($(prefix+"city")?.value||"").trim(),
      state: ($(prefix+"state")?.value||"").trim(),
      address: ($(prefix+"address")?.value||"").trim(),
      zip: ($(prefix+"zip")?.value||"").trim(),
      email: ($(prefix+"email")?.value||"").trim(),
      notes: ($(prefix+"notes")?.value||"").trim(),
    };
  }

  function setProfileFields(kind, p){
    const prefix = kind==="shipper" ? "shipper_" : "consignee_";
    $(prefix+"name").value = p?.name||"";
    $(prefix+"phone").value = p?.phone||"";
    $(prefix+"city").value = p?.city||"";
    $(prefix+"state").value = p?.state||"";
    $(prefix+"address").value = p?.address||"";
    $(prefix+"zip").value = p?.zip||"";
    $(prefix+"email").value = p?.email||"";
    $(prefix+"notes").value = p?.notes||"";
  }

  function pickProfile(kind){
    const pick = $(kind==="shipper" ? "shipperPick" : "consigneePick");
    const id = pick?.value || "";
    const list = kind==="shipper" ? getShippers() : getConsignees();
    const p = list.find(x=>x.id===id);
    setProfileFields(kind, p || null);
  }

  function saveProfile(kind){
    const pick = $(kind==="shipper" ? "shipperPick" : "consigneePick");
    const id = pick?.value || "";
    const list = kind==="shipper" ? getShippers() : getConsignees();

    const fields = getProfileFields(kind);
    if(!fields.name){
      alert("Name is required.");
      return;
    }

    const existingIndex = id ? list.findIndex(x=>x.id===id) : -1;
    if(existingIndex>=0){
      list[existingIndex] = {...list[existingIndex], ...fields};
    }else{
      list.unshift({id: makeId(), ...fields});
    }

    if(kind==="shipper") saveShippers(list); else saveConsignees(list);
    refreshProfilePick(kind);
  }

  function deleteProfile(kind){
    const pick = $(kind==="shipper" ? "shipperPick" : "consigneePick");
    const id = pick?.value || "";
    if(!id){ alert("Pick a profile first."); return; }
    const ok = confirm("Delete this profile?");
    if(!ok) return;

    const list = kind==="shipper" ? getShippers() : getConsignees();
    const next = list.filter(x=>x.id!==id);
    if(kind==="shipper") saveShippers(next); else saveConsignees(next);

    refreshProfilePick(kind);
    setProfileFields(kind, null);
  }

  function clearProfiles(kind){
    const ok = confirm(`Clear ALL ${kind==="shipper"?"Shippers":"Consignees"}? This cannot be undone.`);
    if(!ok) return;
    if(kind==="shipper") saveShippers([]); else saveConsignees([]);
    refreshProfilePick(kind);
    setProfileFields(kind, null);
  }

  // ---------- TABS ----------
  function showTab(tab){
    document.querySelectorAll(".tab").forEach(s=>s.style.display="none");
    const el = document.getElementById("tab-"+tab);
    if(el) el.style.display="block";

    document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
    const btn = document.querySelector(`.tabbtn[data-tab="${tab}"]`);
    if(btn) btn.classList.add("active");

    // keep outputs fresh
    if(tab==="blueprint") renderBlueprint();
    if(tab==="brokers") renderBrokerEmail();
    if(tab==="trip") { refreshTripsDropdown(); refreshTripsList(); previewTrip(); }
  }

  // ---------- REFRESH EVERYTHING ----------
  function refreshAll(){
    previewTrip();
    refreshTripsDropdown();
    refreshTripsList();
    renderBlueprint();
    renderBrokerEmail();
  }

  // ---------- INIT ----------
  function init(){
    // load settings
    const saved = loadJSON(KEY_SETTINGS, null);
    setSettings(saved ? saved : clone(DEFAULTS));
    persistSettings();

    // Tab buttons
    document.querySelectorAll(".tabbtn").forEach(btn=>{
      btn.addEventListener("click", ()=>showTab(btn.dataset.tab));
    });

    // Settings change watchers
    const settingsIds = [
      "fleetMode","driverWageWeekly","fuelPrice","truckMpg","hoursPerLoad","daysPerLoad",
      "avgMilesLoadOtr","avgMilesLoadLocal",
      "hh_house","hh_util","hh_car","hh_groc","hh_carGas","hh_gasUtil",
      "biz_truck","biz_trailer","biz_ins","biz_phone","biz_park","biz_eld","biz_lb",
      "pct_factoring","pct_tax","pct_plates","pct_ifta","pct_maint","pct_hwy","pct_tires","pct_usdot",
      "cap_plates","cap_ifta","cap_maint","cap_hwy","cap_tires","cap_usdot",
      "aftercap_plates","aftercap_ifta","aftercap_maint","aftercap_hwy","aftercap_tires","aftercap_usdot",
      "m_otr","m_local","y_otr","y_local"
    ];
    settingsIds.forEach(id=>{
      bind(id,"input",persistSettings);
      bind(id,"change",persistSettings);
    });

    // Reset
    bind("btnResetDefaults","click", ()=>{
      setSettings(clone(DEFAULTS));
      persistSettings();
    });

    // Trip entry live preview
    ["trip_deadhead","trip_loaded","trip_gross","trip_gallons","trip_misc","trip_hoursAway"].forEach(id=>{
      bind(id,"input",previewTrip);
    });

    // Trip buttons
    bind("btnSaveTrip","click", saveTrip);
    bind("btnClearTrips","click", clearTrips);
    bind("btnExportJson","click", exportTripsJson);
    bind("trip_search","input", refreshTripsList);

    // Pick saved load
    bind("trip_pickLoad","change", ()=>{
      const id = $("trip_pickLoad").value;
      if(!id) return;
      const t = getTrips().find(x=>x.id===id);
      if(t) fillTripEntryFromLoad(t);
    });

    // Invoice buttons
    bind("btnPreviewInvoice","click", previewInvoice);
    bind("btnPrintInvoice","click", printInvoice);

    // Brokers
    bind("brokerScenario","change", renderBrokerEmail);
    bind("btnCopyBroker","click", async ()=>{
      const txt = $("brokerText")?.value || "";
      const ok = await copyText(txt);
      alert(ok ? "Broker email copied." : "Could not copy. (Browser tantrum.)");
    });

    // Profiles
    bind("shipperSearch","input", ()=>refreshProfilePick("shipper"));
    bind("shipperPick","change", ()=>pickProfile("shipper"));
    bind("btnSaveShipper","click", ()=>saveProfile("shipper"));
    bind("btnDeleteShipper","click", ()=>deleteProfile("shipper"));
    bind("btnClearShippers","click", ()=>clearProfiles("shipper"));

    bind("consigneeSearch","input", ()=>refreshProfilePick("consignee"));
    bind("consigneePick","change", ()=>pickProfile("consignee"));
    bind("btnSaveConsignee","click", ()=>saveProfile("consignee"));
    bind("btnDeleteConsignee","click", ()=>deleteProfile("consignee"));
    bind("btnClearConsignees","click", ()=>clearProfiles("consignee"));

    refreshProfilePick("shipper");
    refreshProfilePick("consignee");

    // default tab
    showTab("settings");
    refreshAll();
  }

  // Go.
  init();
})();
</script>
</body>
</html>
