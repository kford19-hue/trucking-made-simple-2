<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Trucking Made Simple — Blueprint (MVP)</title>
<style>
  /* Make width + padding behave on mobile */
  *, *::before, *::after { box-sizing: border-box; }

  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1020;color:#eef2ff}
  header{position:sticky;top:0;background:#070a14;border-bottom:1px solid #22305e}
  .wrap{max-width:1000px;margin:0 auto;padding:14px}
  h1{font-size:18px;margin:0 0 10px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tabbtn{border:1px solid #22305e;background:#121a33;color:#eef2ff;padding:10px 12px;border-radius:12px;font-weight:800}
  .tabbtn.active{border-color:#4aa3ff}

  .card{
    background:#121a33;
    border:1px solid #22305e;
    border-radius:16px;
    padding:12px;
    margin-top:12px;
    overflow:hidden;
  }

  label{display:block;font-size:12px;color:#a9b4d0;margin:10px 0 6px}

  input, select, textarea{
    width:100%;
    max-width:100%;
    padding:10px;
    border-radius:12px;
    border:1px solid #22305e;
    background:#0e1530;
    color:#eef2ff;
  }
  textarea{min-height:150px;}

  .grid{display:grid;gap:12px}
  @media(min-width:900px){.grid.cols2{grid-template-columns:1fr 1fr}}

  /* Mobile-first: stack fields */
  .row{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
  }

  /* Only go 2-column when there's room */
  @media (min-width: 700px){
    .row{ grid-template-columns:1fr 1fr; }
  }

  /* Let button groups wrap on small screens */
  .actions, .btnrow, .tabs, .toolbar{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }

  /* Buttons take up space nicely and wrap instead of overlapping */
  .btn, .tabbtn{
    flex:1 1 160px;
    white-space:normal;
  }

  .btn{border:1px solid #22305e;background:#1a2550;color:#eef2ff;padding:10px 12px;border-radius:12px;font-weight:900}
  .btn.primary{background:#1f5bff;border-color:#2b6cff}
  .btn.good{background:#19b56f;border-color:#1ba86a}
  .btn.bad{background:#ff2f58;border-color:#ff2f58}

  .muted{color:#a9b4d0;font-size:13px}
  .kpi{display:flex;justify-content:space-between;gap:10px;padding:10px;border:1px solid #22305e;border-radius:14px;background:#0c1230;margin-top:8px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;white-space:pre-wrap}
</style>
</head>

<body>
<header><div class="wrap">
  <h1>Trucking Made Simple — Blueprint (Owner-Operator Edition)</h1>
  <div class="tabs">
    <button class="tabbtn active" data-tab="settings">Settings</button>
    <button class="tabbtn" data-tab="blueprint">Blueprint</button>
    <button class="tabbtn" data-tab="brokers">Brokers</button>
    <button class="tabbtn" data-tab="trip">Trip Entry</button>
    <button class="tabbtn" data-tab="invoices">Invoices</button>
    <button class="tabbtn" data-tab="profiles">Shipper/Consignee</button>
  </div>
  <div class="muted" style="margin-top:8px">
    No-Touch Rule: Only <b>Settings</b> is editable. Blueprint/Brokers are read-only outputs. Data saves on this phone (localStorage).
  </div>
</div></header>

<main class="wrap">

<section id="tab-settings" class="tab">
  <div class="grid cols2">
    <div class="card">
      <h2 style="margin:0 0 8px">Mode</h2>
      <label>Fleet Mode (include payroll)</label>
      <select id="fleetMode">
        <option value="false">OFF (Owner-Operator)</option>
        <option value="true">ON (Fleet Mode)</option>
      </select>
      <label>Company driver wage per week (only used when Fleet Mode ON)</label>
      <input id="driverWageWeekly" type="number" step="0.01"/>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Fuel + Time Away</h2>
      <div class="row">
        <div><label>Fuel $/gal</label><input id="fuelPrice" type="number" step="0.001"/></div>
        <div><label>Truck MPG</label><input id="truckMpg" type="number" step="0.01"/></div>
      </div>
      <div class="row">
        <div><label>Hours away per load</label><input id="hoursPerLoad" type="number" step="0.25"/></div>
        <div><label>Days away per load (auto-sync)</label><input id="daysPerLoad" type="number" step="0.01"/></div>
      </div>
      <div class="row">
        <div><label>Avg miles/load (OTR)</label><input id="avgMilesLoadOtr" type="number" step="1"/></div>
        <div><label>Avg miles/load (Local)</label><input id="avgMilesLoadLocal" type="number" step="1"/></div>
      </div>
      <div class="muted" style="margin-top:8px"><b>O.T.R.A.F.F</b> locked: <b>net revenue ÷ hours away from family</b>.</div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Household (Monthly)</h2>
      <div class="row">
        <div><label>House payment</label><input id="hh_house" type="number" step="0.01"/></div>
        <div><label>Utilities</label><input id="hh_util" type="number" step="0.01"/></div>
      </div>
      <div class="row">
        <div><label>Car payment</label><input id="hh_car" type="number" step="0.01"/></div>
        <div><label>Groceries</label><input id="hh_groc" type="number" step="0.01"/></div>
      </div>
      <div class="row">
        <div><label>Car gas (monthly)</label><input id="hh_carGas" type="number" step="0.01"/></div>
        <div><label>Household gas utilities</label><input id="hh_gasUtil" type="number" step="0.01"/></div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Business (Monthly)</h2>
      <div class="row">
        <div><label>Truck payment</label><input id="biz_truck" type="number" step="0.01"/></div>
        <div><label>Trailer payment</label><input id="biz_trailer" type="number" step="0.01"/></div>
      </div>
      <div class="row">
        <div><label>Insurance</label><input id="biz_ins" type="number" step="0.01"/></div>
        <div><label>Business phone</label><input id="biz_phone" type="number" step="0.01"/></div>
      </div>
      <div class="row">
        <div><label>Parking</label><input id="biz_park" type="number" step="0.01"/></div>
        <div><label>ELD</label><input id="biz_eld" type="number" step="0.01"/></div>
      </div>
      <label>Load board</label><input id="biz_lb" type="number" step="0.01"/>
      <div class="muted" style="margin-top:8px">Payroll is handled in Mode (Fleet Mode).</div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <h2 style="margin:0 0 8px">Percent Rules (of Gross) + Annual Caps</h2>
      <div class="muted">Caps are annual; monthly scenario uses cap/12. “Continue after cap” overrides cap.</div>

      <div class="row">
        <div><label>Factoring % (no cap)</label><input id="pct_factoring" type="number" step="0.001"/></div>
        <div><label>Tax reserve % (no cap)</label><input id="pct_tax" type="number" step="0.001"/></div>
      </div>

      <div class="grid cols2">
        <div>
          <label>Plates %</label><input id="pct_plates" type="number" step="0.001"/>
          <label>Plates cap (annual $)</label><input id="cap_plates" type="number" step="0.01"/>
          <label>Continue after cap?</label><select id="aftercap_plates"><option value="false">OFF</option><option value="true">ON</option></select>
        </div>
        <div>
          <label>IFTA %</label><input id="pct_ifta" type="number" step="0.001"/>
          <label>IFTA cap (annual $)</label><input id="cap_ifta" type="number" step="0.01"/>
          <label>Continue after cap?</label><select id="aftercap_ifta"><option value="false">OFF</option><option value="true">ON</option></select>
        </div>
        <div>
          <label>Maintenance %</label><input id="pct_maint" type="number" step="0.001"/>
          <label>Maintenance cap (annual $)</label><input id="cap_maint" type="number" step="0.01"/>
          <label>Continue after cap?</label><select id="aftercap_maint"><option value="false">OFF</option><option value="true">ON</option></select>
        </div>
        <div>
          <label>Heavy highway %</label><input id="pct_hwy" type="number" step="0.001"/>
          <label>Heavy highway cap (annual $)</label><input id="cap_hwy" type="number" step="0.01"/>
          <label>Continue after cap?</label><select id="aftercap_hwy"><option value="false">OFF</option><option value="true">ON</option></select>
        </div>
        <div>
          <label>Tires %</label><input id="pct_tires" type="number" step="0.001"/>
          <label>Tires cap (annual $)</label><input id="cap_tires" type="number" step="0.01"/>
          <label>Continue after cap?</label><select id="aftercap_tires"><option value="false">OFF</option><option value="true">ON</option></select>
        </div>
        <div>
          <label>USDOT %</label><input id="pct_usdot" type="number" step="0.001"/>
          <label>USDOT cap (annual $)</label><input id="cap_usdot" type="number" step="0.01"/>
          <label>Continue after cap?</label><select id="aftercap_usdot"><option value="false">OFF</option><option value="true">ON</option></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div><label>OTR miles per month</label><input id="m_otr" type="number" step="1"/></div>
        <div><label>Local miles per month</label><input id="m_local" type="number" step="1"/></div>
      </div>
      <div class="row">
        <div><label>OTR miles per year</label><input id="y_otr" type="number" step="1"/></div>
        <div><label>Local miles per year</label><input id="y_local" type="number" step="1"/></div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn primary" id="btnResetDefaults">Reset to Defaults</button>
      </div>
    </div>
  </div>
</section>

<section id="tab-blueprint" class="tab" style="display:none">
  <div class="card">
    <h2 style="margin:0 0 6px">Blueprint (Read-Only)</h2>
    <div class="muted">Minimum sustainable rate per mile for each scenario + O.T.R.A.F.F from saved loads.</div>
    <div id="blueprintOut"></div>
  </div>
</section>

<section id="tab-brokers" class="tab" style="display:none">
  <div class="card">
    <h2 style="margin:0 0 6px">Brokers (Copy/Paste Email)</h2>
    <div class="row">
      <div>
        <label>Scenario</label>
        <select id="brokerScenario">
          <option value="OTR_MONTH">OTR (Monthly)</option>
          <option value="LOCAL_MONTH">Local (Monthly)</option>
          <option value="OTR_YEAR">OTR (Yearly)</option>
          <option value="LOCAL_YEAR">Local (Yearly)</option>
        </select>
      </div>
      <div style="align-self:end">
        <button class="btn good" id="btnCopyBroker">Copy Email Text</button>
      </div>
    </div>
    <label>Email block</label>
    <textarea id="brokerText" readonly></textarea>
    <div class="muted">This app formats the email. You copy/paste into Gmail/SMS.</div>
  </div>
</section>

<section id="tab-trip" class="tab" style="display:none">
  <div class="grid cols2">
    <div class="card">
      <h2 style="margin:0 0 6px">Trip Entry (per load)</h2>
      <label>Truck #</label><input id="trip_truck" placeholder="Truck 1"/>
      <div class="row">
        <div><label>Deadhead miles</label><input id="trip_deadhead" type="number" step="1"/></div>
        <div><label>Loaded miles</label><input id="trip_loaded" type="number" step="1"/></div>
      </div>
      <div class="row">
        <div><label>Gross revenue ($)</label><input id="trip_gross" type="number" step="0.01"/></div>
        <div><label>Gallons used</label><input id="trip_gallons" type="number" step="0.01"/></div>
      </div>
      <div class="row">
        <div><label>Tolls/misc ($)</label><input id="trip_misc" type="number" step="0.01"/></div>
        <div><label>Hours away (this load)</label><input id="trip_hoursAway" type="number" step="0.25"/></div>
      </div>
      <label>Notes</label><input id="trip_notes" placeholder="lane, broker, etc."/>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn primary" id="btnSaveTrip">Save Load</button>
        <button class="btn bad" id="btnClearTrips">Clear All Loads</button>
      </div>
      <div class="kpi"><b>Auto MPG (this load)</b><div id="trip_mpg">—</div></div>
      <div class="kpi"><b>Net revenue (this load)</b><div id="trip_net">—</div></div>
      <div class="kpi"><b>O.T.R.A.F.F (this load)</b><div id="trip_otraff">—</div></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 6px">Load History</h2>

      <!-- ✅ NEW: DROPDOWN FOR SAVED LOADS -->
      <label>Loads (dropdown)</label>
      <select id="trip_pick"></select>

      <label>Search</label><input id="trip_search" placeholder="search notes/truck"/>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn" id="btnExportJson">Copy Trips JSON</button>
      </div>
      <div id="trip_list" style="margin-top:10px"></div>
    </div>
  </div>
</section>

<!-- ✅ NEW TAB: INVOICES -->
<section id="tab-invoices" class="tab" style="display:none">
  <div class="card">
    <h2 style="margin:0 0 6px">Invoices</h2>
    <div class="muted">Preview pulls everything from the Trip Entry tab (current fields + KPIs + Load History). Print opens a clean printable page.</div>

    <div class="actions" style="margin-top:10px">
      <button class="btn primary" id="btnPreviewInvoice">Preview</button>
      <button class="btn" id="btnPrintInvoice">Print</button>
    </div>

    <div id="invoiceOut" style="margin-top:12px"></div>
  </div>
</section>

<section id="tab-profiles" class="tab" style="display:none">
  <div class="grid cols2">
    <div class="card">
      <h2 style="margin:0 0 6px">Shipper Profiles</h2>
      <label>Search as you type</label><input id="shipperSearch" placeholder="name, city, phone..."/>
      <select id="shipperPick" size="6" style="margin-top:10px"></select>
      <div class="row">
        <div><label>Name</label><input id="shipper_name"/></div>
        <div><label>Phone</label><input id="shipper_phone"/></div>
      </div>
      <div class="row">
        <div><label>City</label><input id="shipper_city"/></div>
        <div><label>State</label><input id="shipper_state"/></div>
      </div>
      <label>Address</label><input id="shipper_address"/>
      <div class="row">
        <div><label>Zip</label><input id="shipper_zip"/></div>
        <div><label>Email</label><input id="shipper_email"/></div>
      </div>
      <label>Notes</label><input id="shipper_notes"/>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn good" id="btnSaveShipper">Save/Update</button>
        <button class="btn bad" id="btnDeleteShipper">Delete</button>
        <button class="btn" id="btnClearShippers">Clear All</button>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 6px">Consignee Profiles + Calendar</h2>
      <label>Pickup/Delivery date</label><input id="datePick" type="date"/>
      <label>Search as you type</label><input id="consigneeSearch" placeholder="name, city, phone..."/>
      <select id="consigneePick" size="6" style="margin-top:10px"></select>
      <div class="row">
        <div><label>Name</label><input id="consignee_name"/></div>
        <div><label>Phone</label><input id="consignee_phone"/></div>
      </div>
      <div class="row">
        <div><label>City</label><input id="consignee_city"/></div>
        <div><label>State</label><input id="consignee_state"/></div>
      </div>
      <label>Address</label><input id="consignee_address"/>
      <div class="row">
        <div><label>Zip</label><input id="consignee_zip"/></div>
        <div><label>Email</label><input id="consignee_email"/></div>
      </div>
      <label>Notes</label><input id="consignee_notes"/>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn good" id="btnSaveConsignee">Save/Update</button>
        <button class="btn bad" id="btnDeleteConsignee">Delete</button>
        <button class="btn" id="btnClearConsignees">Clear All</button>
      </div>
    </div>
  </div>
</section>

</main>

<script>
const KEY_SETTINGS="tms_settings_v1";
const KEY_TRIPS="tms_trips_v1";
const KEY_SHIPPERS="tms_shippers_v1";
const KEY_CONSIGNEES="tms_consignee_v1";

const DEFAULTS={
  fleetMode:false, driverWageWeekly:1000,
  fuelPrice:3.659, truckMpg:4.60,
  hoursPerLoad:48, daysPerLoad:2,
  avgMilesLoadOtr:600, avgMilesLoadLocal:250,
  household:{house:1500, util:500, car:500, groc:700, carGas:0, gasUtil:400},
  business:{truck:1500, trailer:1100, ins:1500, phone:150, park:300, eld:25, lb:169},
  pct:{factoring:0.02, tax:0.28, plates:0.05, ifta:0.05, maint:0.07, hwy:0.02, tires:0.05, usdot:0.02},
  cap:{plates:2500, ifta:2500, maint:5000, hwy:550, tires:5000, usdot:150},
  afterCap:{plates:false, ifta:false, maint:false, hwy:false, tires:false, usdot:false},
  miles:{otrMonth:12500, localMonth:6000, otrYear:144000, localYear:72000}
};

const $=id=>document.getElementById(id);
const num=v=>Number(v||0);
const money=n=>Number(n||0).toLocaleString(undefined,{style:"currency",currency:"USD"});

function loadJSON(key, fallback){try{const r=localStorage.getItem(key);return r?JSON.parse(r):fallback}catch{return fallback}}
function saveJSON(key, obj){localStorage.setItem(key, JSON.stringify(obj))}

document.querySelectorAll(".tabbtn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll("section.tab").forEach(s=>s.style.display="none");
    $("tab-"+btn.dataset.tab).style.display="block";
    refreshAll();
  });
});

function getSettings(){
  const s={
    fleetMode: $("fleetMode").value==="true",
    driverWageWeekly: num($("driverWageWeekly").value),
    fuelPrice: num($("fuelPrice").value),
    truckMpg: num($("truckMpg").value) || DEFAULTS.truckMpg,
    hoursPerLoad: num($("hoursPerLoad").value),
    daysPerLoad: num($("daysPerLoad").value),
    avgMilesLoadOtr: num($("avgMilesLoadOtr").value),
    avgMilesLoadLocal: num($("avgMilesLoadLocal").value),
    household:{
      house:num($("hh_house").value), util:num($("hh_util").value), car:num($("hh_car").value),
      groc:num($("hh_groc").value), carGas:num($("hh_carGas").value), gasUtil:num($("hh_gasUtil").value)
    },
    business:{
      truck:num($("biz_truck").value), trailer:num($("biz_trailer").value), ins:num($("biz_ins").value),
      phone:num($("biz_phone").value), park:num($("biz_park").value), eld:num($("biz_eld").value), lb:num($("biz_lb").value)
    },
    pct:{
      factoring:num($("pct_factoring").value), tax:num($("pct_tax").value),
      plates:num($("pct_plates").value), ifta:num($("pct_ifta").value), maint:num($("pct_maint").value),
      hwy:num($("pct_hwy").value), tires:num($("pct_tires").value), usdot:num($("pct_usdot").value)
    },
    cap:{
      plates:num($("cap_plates").value), ifta:num($("cap_ifta").value), maint:num($("cap_maint").value),
      hwy:num($("cap_hwy").value), tires:num($("cap_tires").value), usdot:num($("cap_usdot").value)
    },
    afterCap:{
      plates:$("aftercap_plates").value==="true", ifta:$("aftercap_ifta").value==="true",
      maint:$("aftercap_maint").value==="true", hwy:$("aftercap_hwy").value==="true",
      tires:$("aftercap_tires").value==="true", usdot:$("aftercap_usdot").value==="true"
    },
    miles:{
      otrMonth:num($("m_otr").value), localMonth:num($("m_local").value),
      otrYear:num($("y_otr").value), localYear:num($("y_local").value)
    }
  };

  // sync hours/days
  if(s.hoursPerLoad>0) s.daysPerLoad = s.hoursPerLoad/24;
  if(s.daysPerLoad>0 && s.hoursPerLoad<=0) s.hoursPerLoad = s.daysPerLoad*24;

  return s;
}

function setSettings(s){
  $("fleetMode").value=String(!!s.fleetMode);
  $("driverWageWeekly").value=s.driverWageWeekly;

  $("fuelPrice").value=s.fuelPrice;
  $("truckMpg").value=s.truckMpg;

  $("hoursPerLoad").value=s.hoursPerLoad;
  $("daysPerLoad").value=s.daysPerLoad;

  $("avgMilesLoadOtr").value=s.avgMilesLoadOtr;
  $("avgMilesLoadLocal").value=s.avgMilesLoadLocal;

  $("hh_house").value=s.household.house; $("hh_util").value=s.household.util;
  $("hh_car").value=s.household.car; $("hh_groc").value=s.household.groc;
  $("hh_carGas").value=s.household.carGas; $("hh_gasUtil").value=s.household.gasUtil;

  $("biz_truck").value=s.business.truck; $("biz_trailer").value=s.business.trailer;
  $("biz_ins").value=s.business.ins; $("biz_phone").value=s.business.phone;
  $("biz_park").value=s.business.park; $("biz_eld").value=s.business.eld; $("biz_lb").value=s.business.lb;

  $("pct_factoring").value=s.pct.factoring; $("pct_tax").value=s.pct.tax;
  $("pct_plates").value=s.pct.plates; $("cap_plates").value=s.cap.plates; $("aftercap_plates").value=String(!!s.afterCap.plates);
  $("pct_ifta").value=s.pct.ifta; $("cap_ifta").value=s.cap.ifta; $("aftercap_ifta").value=String(!!s.afterCap.ifta);
  $("pct_maint").value=s.pct.maint; $("cap_maint").value=s.cap.maint; $("aftercap_maint").value=String(!!s.afterCap.maint);
  $("pct_hwy").value=s.pct.hwy; $("cap_hwy").value=s.cap.hwy; $("aftercap_hwy").value=String(!!s.afterCap.hwy);
  $("pct_tires").value=s.pct.tires; $("cap_tires").value=s.cap.tires; $("aftercap_tires").value=String(!!s.afterCap.tires);
  $("pct_usdot").value=s.pct.usdot; $("cap_usdot").value=s.cap.usdot; $("aftercap_usdot").value=String(!!s.afterCap.usdot);

  $("m_otr").value=s.miles.otrMonth; $("m_local").value=s.miles.localMonth;
  $("y_otr").value=s.miles.otrYear; $("y_local").value=s.miles.localYear;
}

function persistSettings(){ saveJSON(KEY_SETTINGS, getSettings()); refreshAll(); }

[
  "fleetMode","driverWageWeekly","fuelPrice","truckMpg","hoursPerLoad","daysPerLoad","avgMilesLoadOtr","avgMilesLoadLocal",
  "hh_house","hh_util","hh_car","hh_groc","hh_carGas","hh_gasUtil",
  "biz_truck","biz_trailer","biz_ins","biz_phone","biz_park","biz_eld","biz_lb",
  "pct_factoring","pct_tax","pct_plates","cap_plates","aftercap_plates",
  "pct_ifta","cap_ifta","aftercap_ifta",
  "pct_maint","cap_maint","aftercap_maint",
  "pct_hwy","cap_hwy","aftercap_hwy",
  "pct_tires","cap_tires","aftercap_tires",
  "pct_usdot","cap_usdot","aftercap_usdot",
  "m_otr","m_local","y_otr","y_local"
].forEach(id=>{ $(id).addEventListener("input",persistSettings); $(id).addEventListener("change",persistSettings); });

$("hoursPerLoad").addEventListener("input",()=>{ $("daysPerLoad").value=(num($("hoursPerLoad").value)/24).toFixed(2); });
$("daysPerLoad").addEventListener("input",()=>{ $("hoursPerLoad").value=(num($("daysPerLoad").value)*24).toFixed(2); });

$("btnResetDefaults").addEventListener("click",()=>{ setSettings(structuredClone(DEFAULTS)); persistSettings(); });

function monthlyTotals(s){
  const hh=Object.values(s.household).reduce((a,b)=>a+num(b),0);
  let biz=Object.values(s.business).reduce((a,b)=>a+num(b),0);
  if(s.fleetMode) biz += num(s.driverWageWeekly)*52/12;
  return {hh,biz};
}
function fuelCostForMiles(s,miles){ return (miles/Math.max(0.01,s.truckMpg))*s.fuelPrice; }
function capForPeriod(annualCap, period){ return period==="year"?annualCap:annualCap/12; }
function cappedAmt(gross,p,capAnnual,period,after){ const raw=gross*p; const cap=capForPeriod(capAnnual,period); return after?raw:Math.min(raw,cap); }

function solveGrossRequired(s,miles,period){
  const {hh,biz}=monthlyTotals(s);
  const fixed=(period==="year")?(hh+biz)*12:(hh+biz);
  const fuel=fuelCostForMiles(s,miles);
  let gross=(fixed+fuel)/Math.max(0.01,(1-(s.pct.factoring+s.pct.tax+s.pct.plates+s.pct.ifta+s.pct.maint+s.pct.hwy+s.pct.tires+s.pct.usdot)));

  for(let i=0;i<60;i++){
    const factoring=gross*s.pct.factoring;
    const tax=gross*s.pct.tax;
    const plates=cappedAmt(gross,s.pct.plates,s.cap.plates,period,s.afterCap.plates);
    const ifta=cappedAmt(gross,s.pct.ifta,s.cap.ifta,period,s.afterCap.ifta);
    const maint=cappedAmt(gross,s.pct.maint,s.cap.maint,period,s.afterCap.maint);
    const hwy=cappedAmt(gross,s.pct.hwy,s.cap.hwy,period,s.afterCap.hwy);
    const tires=cappedAmt(gross,s.pct.tires,s.cap.tires,period,s.afterCap.tires);
    const usdot=cappedAmt(gross,s.pct.usdot,s.cap.usdot,period,s.afterCap.usdot);
    const next=fixed+fuel+factoring+tax+plates+ifta+maint+hwy+tires+usdot;
    if(Math.abs(next-gross)<1e-6*Math.max(1,gross)){gross=next;break}
    gross=next;
  }
  const r={period,miles,fixed,fuel,gross,rpm:gross/Math.max(1,miles)};
  r.factoring=gross*s.pct.factoring; r.tax=gross*s.pct.tax;
  r.plates=cappedAmt(gross,s.pct.plates,s.cap.plates,period,s.afterCap.plates);
  r.ifta=cappedAmt(gross,s.pct.ifta,s.cap.ifta,period,s.afterCap.ifta);
  r.maint=cappedAmt(gross,s.pct.maint,s.cap.maint,period,s.afterCap.maint);
  r.hwy=cappedAmt(gross,s.pct.hwy,s.cap.hwy,period,s.afterCap.hwy);
  r.tires=cappedAmt(gross,s.pct.tires,s.cap.tires,period,s.afterCap.tires);
  r.usdot=cappedAmt(gross,s.pct.usdot,s.cap.usdot,period,s.afterCap.usdot);
  r.totalPercentFees=r.factoring+r.tax+r.plates+r.ifta+r.maint+r.hwy+r.tires+r.usdot;
  r.netAfterAll=r.gross - r.totalPercentFees - r.fuel - r.fixed; // should be ~0 by construction
  return r;
}

function computeOTRAFFFromTrips(trips){
  const hours=trips.reduce((a,t)=>a+num(t.hoursAway),0);
  const net=trips.reduce((a,t)=>a+num(t.net),0);
  return {hours, net, otrAff: hours>0 ? (net/hours) : 0};
}

function renderBlueprint(){
  const s=getSettings();
  const trips=loadJSON(KEY_TRIPS, []);
  const otr=computeOTRAFFFromTrips(trips);

  const scenarios=[
    {key:"OTR_MONTH", label:"OTR (Monthly)", miles:s.miles.otrMonth, period:"month"},
    {key:"LOCAL_MONTH", label:"Local (Monthly)", miles:s.miles.localMonth, period:"month"},
    {key:"OTR_YEAR", label:"OTR (Yearly)", miles:s.miles.otrYear, period:"year"},
    {key:"LOCAL_YEAR", label:"Local (Yearly)", miles:s.miles.localYear, period:"year"},
  ];

  const rows=scenarios.map(sc=>{
    const r=solveGrossRequired(s, sc.miles, sc.period);
    return `
      <div class="card" style="margin-top:10px">
        <div class="kpi"><b>${sc.label}</b><div>${sc.miles.toLocaleString()} mi / ${sc.period}</div></div>
        <div class="kpi"><b>Required gross</b><div>${money(r.gross)}</div></div>
        <div class="kpi"><b>Required rate / mi</b><div>${money(r.rpm)}</div></div>
        <div class="muted" style="margin-top:8px">
          Fixed: ${money(r.fixed)} • Fuel: ${money(r.fuel)} • Reserves/percents: ${money(r.totalPercentFees)}
        </div>
      </div>
    `;
  }).join("");

  const otrAffBlock = `
    <div class="card" style="margin-top:10px">
      <h3 style="margin:0 0 6px">O.T.R.A.F.F (from saved loads)</h3>
      <div class="muted">Locked rule: <b>net revenue ÷ hours away from family</b>.</div>
      <div class="kpi"><b>Total hours away</b><div>${otr.hours.toFixed(2)}</div></div>
      <div class="kpi"><b>Total net revenue</b><div>${money(otr.net)}</div></div>
      <div class="kpi"><b>O.T.R.A.F.F</b><div>${money(otr.otrAff)}/hr</div></div>
    </div>
  `;

  $("blueprintOut").innerHTML = rows + otrAffBlock;
}

function buildBrokerEmail(){
  const s=getSettings();
  const scenario=$("brokerScenario").value;

  const map={
    "OTR_MONTH": {label:"OTR (Monthly)", miles:s.miles.otrMonth, period:"month"},
    "LOCAL_MONTH": {label:"Local (Monthly)", miles:s.miles.localMonth, period:"month"},
    "OTR_YEAR": {label:"OTR (Yearly)", miles:s.miles.otrYear, period:"year"},
    "LOCAL_YEAR": {label:"Local (Yearly)", miles:s.miles.localYear, period:"year"},
  };
  const sc=map[scenario] || map.OTR_MONTH;
  const r=solveGrossRequired(s, sc.miles, sc.period);

  // A broker-facing ask: keep it clean, no household details, just the ask and what you need.
  const txt =
`Subject: Rate request — ${sc.label}

Hi [Broker Name],

I’m available for ${sc.label.toLowerCase()} freight. Based on my current operating costs and fuel, my minimum sustainable rate is:

• Target all-in rate: ${money(r.rpm)}/mile
• Target gross for ${sc.period}: ${money(r.gross)}
• Mileage assumption: ${sc.miles.toLocaleString()} miles/${sc.period}

Please send over any lanes you have that meet or exceed this rate (or close enough to negotiate).

Thank you,
[Your Name]
[MC# / DOT#]
[Phone]`;

  return txt;
}

function renderBroker(){
  $("brokerText").value = buildBrokerEmail();
}

$("brokerScenario").addEventListener("change",renderBroker);
$("btnCopyBroker").addEventListener("click", async ()=>{
  const txt=$("brokerText").value || buildBrokerEmail();
  try{ await navigator.clipboard.writeText(txt); $("btnCopyBroker").textContent="Copied ✅"; setTimeout(()=>{$("btnCopyBroker").textContent="Copy Email Text"},900); }
  catch{ alert("Copy failed. Select the text and copy manually."); }
});

/* -----------------------------
   Trips (Load Entry + History)
--------------------------------*/
function tripFromInputs(){
  const s=getSettings();
  const dead=num($("trip_deadhead").value);
  const loaded=num($("trip_loaded").value);
  const miles=dead+loaded;

  const gross=num($("trip_gross").value);
  const gallons=num($("trip_gallons").value);
  const misc=num($("trip_misc").value);
  const hoursAway=num($("trip_hoursAway").value);

  const fuelCost=gallons * s.fuelPrice;

  // For per-load “net”, we apply percent reserves as simple percents (caps are annual logic).
  const pctTotal = s.pct.factoring+s.pct.tax+s.pct.plates+s.pct.ifta+s.pct.maint+s.pct.hwy+s.pct.tires+s.pct.usdot;
  const pctFees = gross * pctTotal;

  const net = gross - fuelCost - misc - pctFees;
  const mpg = gallons>0 ? (miles/gallons) : 0;
  const otrAff = hoursAway>0 ? (net/hoursAway) : 0;

  return {
    id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()),
    ts: Date.now(),
    truck: ($("trip_truck").value||"").trim(),
    deadhead: dead,
    loaded: loaded,
    miles: miles,
    gross: gross,
    gallons: gallons,
    misc: misc,
    hoursAway: hoursAway,
    notes: ($("trip_notes").value||"").trim(),
    fuelPrice: s.fuelPrice,
    fuelCost,
    pctTotal,
    pctFees,
    mpg,
    net,
    otrAff
  };
}

function updateTripKPIsFromInputs(){
  const t=tripFromInputs();
  $("trip_mpg").textContent = t.gallons>0 ? t.mpg.toFixed(2) : "—";
  $("trip_net").textContent = (t.gross>0 || t.gallons>0 || t.misc>0) ? money(t.net) : "—";
  $("trip_otraff").textContent = (t.hoursAway>0) ? (money(t.otrAff)+"/hr") : "—";
}

["trip_truck","trip_deadhead","trip_loaded","trip_gross","trip_gallons","trip_misc","trip_hoursAway","trip_notes"]
  .forEach(id=>$(id).addEventListener("input",updateTripKPIsFromInputs));

function saveTrip(){
  const trips=loadJSON(KEY_TRIPS, []);
  const t=tripFromInputs();
  // basic validation so humans can’t sabotage themselves (they will try)
  if(!t.gross || t.gross<=0){ alert("Gross revenue is required."); return; }
  trips.unshift(t);
  saveJSON(KEY_TRIPS, trips);
  refreshTripsUI();
  updateTripKPIsFromInputs();
}

function clearTrips(){
  if(!confirm("Clear ALL saved loads? This cannot be undone.")) return;
  saveJSON(KEY_TRIPS, []);
  refreshTripsUI();
  updateTripKPIsFromInputs();
}

$("btnSaveTrip").addEventListener("click",saveTrip);
$("btnClearTrips").addEventListener("click",clearTrips);

$("btnExportJson").addEventListener("click", async ()=>{
  const trips=loadJSON(KEY_TRIPS, []);
  const txt=JSON.stringify(trips,null,2);
  try{ await navigator.clipboard.writeText(txt); $("btnExportJson").textContent="Copied ✅"; setTimeout(()=>{$("btnExportJson").textContent="Copy Trips JSON"},900); }
  catch{ alert("Copy failed. Select and copy manually:\n\n"+txt); }
});

$("trip_search").addEventListener("input",refreshTripsUI);

function refreshTripsUI(){
  const trips=loadJSON(KEY_TRIPS, []);
  const q=($("trip_search").value||"").toLowerCase().trim();

  // dropdown
  const pick=$("trip_pick");
  pick.innerHTML = "";
  const opt0=document.createElement("option");
  opt0.value="";
  opt0.textContent = trips.length ? "Select a saved load…" : "No saved loads yet";
  pick.appendChild(opt0);

  trips.forEach((t,idx)=>{
    const o=document.createElement("option");
    o.value=t.id;
    const dt=new Date(t.ts);
    o.textContent = `${idx+1}. ${dt.toLocaleDateString()} ${dt.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"})} • ${t.truck||"—"} • ${t.miles||0} mi • ${money(t.gross)}`;
    pick.appendChild(o);
  });

  // list
  const filtered = q
    ? trips.filter(t=>{
        const hay = `${t.truck} ${t.notes}`.toLowerCase();
        return hay.includes(q);
      })
    : trips;

  $("trip_list").innerHTML = filtered.map(t=>{
    const dt=new Date(t.ts);
    return `
      <div class="card" style="margin-top:10px">
        <div class="kpi"><b>${dt.toLocaleString()}</b><div>${t.truck||"—"}</div></div>
        <div class="kpi"><b>Miles (dead/loaded)</b><div>${t.deadhead||0} / ${t.loaded||0} (Total ${t.miles||0})</div></div>
        <div class="kpi"><b>Gross</b><div>${money(t.gross)}</div></div>
        <div class="kpi"><b>Fuel</b><div>${t.gallons||0} gal @ ${money(t.fuelPrice)}/gal = ${money(t.fuelCost)}</div></div>
        <div class="kpi"><b>Misc</b><div>${money(t.misc)}</div></div>
        <div class="kpi"><b>% Fees (all)</b><div>${(t.pctTotal*100).toFixed(2)}% = ${money(t.pctFees)}</div></div>
        <div class="kpi"><b>Net</b><div>${money(t.net)}</div></div>
        <div class="kpi"><b>Hours away</b><div>${(t.hoursAway||0).toFixed(2)}</div></div>
        <div class="kpi"><b>O.T.R.A.F.F</b><div>${money(t.otrAff)}/hr</div></div>
        <div class="muted" style="margin-top:8px">${(t.notes||"").replaceAll("<","&lt;")}</div>
      </div>
    `;
  }).join("");

  // keep broker + blueprint up to date too
  renderBlueprint();
  renderBroker();
  renderInvoicePreview(); // preview stays current
}

$("trip_pick").addEventListener("change",()=>{
  const id=$("trip_pick").value;
  const trips=loadJSON(KEY_TRIPS, []);
  const t=trips.find(x=>x.id===id);
  if(!t) return;

  // Fill the Trip Entry inputs with the selected load (nice UX)
  $("trip_truck").value=t.truck||"";
  $("trip_deadhead").value=t.deadhead||0;
  $("trip_loaded").value=t.loaded||0;
  $("trip_gross").value=t.gross||0;
  $("trip_gallons").value=t.gallons||0;
  $("trip_misc").value=t.misc||0;
  $("trip_hoursAway").value=t.hoursAway||0;
  $("trip_notes").value=t.notes||"";
  updateTripKPIsFromInputs();
});

/* -----------------------------
   Invoices (Preview + Print)
--------------------------------*/
function getInvoiceModel(){
  const s=getSettings();
  const trips=loadJSON(KEY_TRIPS, []);
  const nowInputs=tripFromInputs(); // pulls current fields + computed KPIs

  // If dropdown selection matches, use that as “Selected load”
  const selectedId=$("trip_pick").value;
  const selected = trips.find(t=>t.id===selectedId) || null;

  const otr=computeOTRAFFFromTrips(trips);

  return {s,trips,nowInputs,selected,otr};
}

function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function invoiceHtml(model){
  const {s,trips,nowInputs,selected,otr}=model;

  const loadBlock = (t, title)=>`
    <div class="card" style="margin-top:10px">
      <h3 style="margin:0 0 8px">${title}</h3>
      <div class="kpi"><b>Truck</b><div>${escapeHtml(t.truck||"—")}</div></div>
      <div class="kpi"><b>Date/Time saved</b><div>${t.ts ? new Date(t.ts).toLocaleString() : "Not saved yet"}</div></div>
      <div class="kpi"><b>Deadhead / Loaded / Total</b><div>${t.deadhead||0} / ${t.loaded||0} / ${t.miles||0} mi</div></div>
      <div class="kpi"><b>Gross</b><div>${money(t.gross)}</div></div>
      <div class="kpi"><b>Fuel</b><div>${t.gallons||0} gal @ ${money(t.fuelPrice||s.fuelPrice)}/gal = ${money(t.fuelCost||0)}</div></div>
      <div class="kpi"><b>Tolls/Misc</b><div>${money(t.misc)}</div></div>
      <div class="kpi"><b>% Fees (all)</b><div>${((t.pctTotal||0)*100).toFixed(2)}% = ${money(t.pctFees||0)}</div></div>
      <div class="kpi"><b>Net</b><div>${money(t.net||0)}</div></div>
      <div class="kpi"><b>Hours away</b><div>${(t.hoursAway||0).toFixed(2)}</div></div>
      <div class="kpi"><b>Auto MPG</b><div>${t.gallons>0 ? (t.mpg||0).toFixed(2) : "—"}</div></div>
      <div class="kpi"><b>O.T.R.A.F.F</b><div>${t.hoursAway>0 ? (money(t.otrAff||0)+"/hr") : "—"}</div></div>
      <div class="muted" style="margin-top:8px">${escapeHtml(t.notes||"")}</div>
    </div>
  `;

  const historyTable = trips.length ? `
    <div class="card" style="margin-top:10px">
      <h3 style="margin:0 0 8px">All Saved Loads (${trips.length})</h3>
      <div style="overflow:auto">
        <table style="width:100%;border-collapse:collapse;font-size:12px">
          <thead>
            <tr>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #22305e">Date</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #22305e">Truck</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid #22305e">Miles</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid #22305e">Gross</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid #22305e">Net</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid #22305e">Hours</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid #22305e">OTRAFF</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #22305e">Notes</th>
            </tr>
          </thead>
          <tbody>
            ${trips.map(t=>`
              <tr>
                <td style="padding:8px;border-bottom:1px solid #22305e">${new Date(t.ts).toLocaleString()}</td>
                <td style="padding:8px;border-bottom:1px solid #22305e">${escapeHtml(t.truck||"")}</td>
                <td style="padding:8px;border-bottom:1px solid #22305e;text-align:right">${(t.miles||0).toLocaleString()}</td>
                <td style="padding:8px;border-bottom:1px solid #22305e;text-align:right">${money(t.gross||0)}</td>
                <td style="padding:8px;border-bottom:1px solid #22305e;text-align:right">${money(t.net||0)}</td>
                <td style="padding:8px;border-bottom:1px solid #22305e;text-align:right">${(t.hoursAway||0).toFixed(2)}</td>
                <td style="padding:8px;border-bottom:1px solid #22305e;text-align:right">${t.hoursAway>0 ? money(t.otrAff||0)+"/hr" : "—"}</td>
                <td style="padding:8px;border-bottom:1px solid #22305e">${escapeHtml(t.notes||"")}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    </div>
  ` : `<div class="card" style="margin-top:10px" class="muted">No saved loads yet.</div>`;

  return `
    <div class="card">
      <h3 style="margin:0 0 6px">Invoice Preview (Trip Data Dump)</h3>
      <div class="muted">This is intentionally “show everything” so nothing goes missing at print time.</div>

      <div class="kpi"><b>Fleet Mode</b><div>${s.fleetMode ? "ON" : "OFF"}</div></div>
      <div class="kpi"><b>Fuel $/gal</b><div>${money(s.fuelPrice)}</div></div>
      <div class="kpi"><b>Truck MPG (setting)</b><div>${num(s.truckMpg).toFixed(2)}</div></div>

      <div class="kpi"><b>All Loads O.T.R.A.F.F</b><div>${money(otr.otrAff)}/hr</div></div>
      <div class="kpi"><b>All Loads Total Net</b><div>${money(otr.net)}</div></div>
      <div class="kpi"><b>All Loads Total Hours Away</b><div>${otr.hours.toFixed(2)}</div></div>
    </div>

    ${loadBlock(nowInputs, "Current Trip Entry (not necessarily saved)")}
    ${selected ? loadBlock(selected, "Selected Saved Load (from dropdown)") : ""}

    ${historyTable}
  `;
}

function renderInvoicePreview(){
  const model=getInvoiceModel();
  $("invoiceOut").innerHTML = invoiceHtml(model);
}

$("btnPreviewInvoice").addEventListener("click",renderInvoicePreview);

$("btnPrintInvoice").addEventListener("click",()=>{
  const model=getInvoiceModel();
  const content = invoiceHtml(model);

  const w=window.open("", "_blank");
  if(!w){ alert("Popup blocked. Allow popups to print."); return; }

  w.document.open();
  w.document.write(`<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Invoice Print</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:18px;color:#111}
  h2,h3{margin:0 0 10px}
  .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin-top:12px}
  .muted{color:#555;font-size:12px}
  .kpi{display:flex;justify-content:space-between;gap:10px;padding:8px;border:1px solid #eee;border-radius:10px;margin-top:8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eee;vertical-align:top}
  th{text-align:left}
  @media print{
    body{margin:0}
    .card{break-inside:avoid-page}
  }
</style>
</head>
<body>
  <h2>Invoice / Trip Summary</h2>
  <div class="muted">Generated: ${new Date().toLocaleString()}</div>
  ${content}
  <script>window.onload=()=>window.print();</script>
</body>
</html>`);
  w.document.close();
});

/* -----------------------------
   Profiles (Shipper / Consignee)
--------------------------------*/
function loadProfiles(key){ return loadJSON(key, []); }
function saveProfiles(key, arr){ saveJSON(key, arr); }

function normalize(s){ return String(s||"").toLowerCase().trim(); }

function refreshPickList(key, pickId, searchId){
  const arr=loadProfiles(key);
  const q=normalize($(searchId).value);
  const pick=$(pickId);
  pick.innerHTML="";

  const filtered = q
    ? arr.filter(p=>{
        const hay=normalize(`${p.name} ${p.city} ${p.state} ${p.phone} ${p.email} ${p.address} ${p.zip} ${p.notes}`);
        return hay.includes(q);
      })
    : arr;

  filtered.forEach(p=>{
    const o=document.createElement("option");
    o.value=p.id;
    o.textContent = `${p.name||"—"} • ${p.city||""} ${p.state||""} • ${p.phone||""}`;
    pick.appendChild(o);
  });

  if(!filtered.length){
    const o=document.createElement("option");
    o.value="";
    o.textContent="No matches";
    pick.appendChild(o);
  }
}

function upsertProfile(key, profile){
  const arr=loadProfiles(key);
  const idx=arr.findIndex(p=>p.id===profile.id);
  if(idx>=0) arr[idx]=profile; else arr.unshift(profile);
  saveProfiles(key, arr);
}

function deleteProfile(key, id){
  const arr=loadProfiles(key).filter(p=>p.id!==id);
  saveProfiles(key, arr);
}

function clearProfiles(key){
  if(!confirm("Clear ALL profiles?")) return;
  saveProfiles(key, []);
}

function profileFromFields(prefix){
  return {
    id: ($(prefix+"Pick")?.value && $(prefix+"Pick").value!=="No matches") ? $(prefix+"Pick").value : (crypto?.randomUUID?crypto.randomUUID():String(Date.now()+Math.random())),
    name: $(prefix+"_name").value.trim(),
    phone: $(prefix+"_phone").value.trim(),
    city: $(prefix+"_city").value.trim(),
    state: $(prefix+"_state").value.trim(),
    address: $(prefix+"_address").value.trim(),
    zip: $(prefix+"_zip").value.trim(),
    email: $(prefix+"_email").value.trim(),
    notes: $(prefix+"_notes").value.trim()
  };
}

function fillProfileFields(prefix, p){
  $(prefix+"_name").value=p?.name||"";
  $(prefix+"_phone").value=p?.phone||"";
  $(prefix+"_city").value=p?.city||"";
  $(prefix+"_state").value=p?.state||"";
  $(prefix+"_address").value=p?.address||"";
  $(prefix+"_zip").value=p?.zip||"";
  $(prefix+"_email").value=p?.email||"";
  $(prefix+"_notes").value=p?.notes||"";
}

function hookProfiles(kind){
  // kind: "shipper" or "consignee"
  const key = kind==="shipper" ? KEY_SHIPPERS : KEY_CONSIGNEES;

  $(kind+"Search").addEventListener("input",()=>refreshPickList(key, kind+"Pick", kind+"Search"));
  $(kind+"Pick").addEventListener("change",()=>{
    const id=$(kind+"Pick").value;
    const arr=loadProfiles(key);
    const p=arr.find(x=>x.id===id);
    if(p) fillProfileFields(kind,p);
  });

  $("btnSave"+(kind==="shipper"?"Shipper":"Consignee")).addEventListener("click",()=>{
    const p=profileFromFields(kind);
    if(!p.name){ alert("Name is required."); return; }
    upsertProfile(key,p);
    refreshPickList(key, kind+"Pick", kind+"Search");
  });

  $("btnDelete"+(kind==="shipper"?"Shipper":"Consignee")).addEventListener("click",()=>{
    const id=$(kind+"Pick").value;
    if(!id || id==="No matches"){ alert("Pick a profile to delete."); return; }
    if(!confirm("Delete this profile?")) return;
    deleteProfile(key,id);
    fillProfileFields(kind,null);
    refreshPickList(key, kind+"Pick", kind+"Search");
  });

  $("btnClear"+(kind==="shipper"?"Shippers":"Consignees")).addEventListener("click",()=>{
    clearProfiles(key);
    fillProfileFields(kind,null);
    refreshPickList(key, kind+"Pick", kind+"Search");
  });

  // initial list
  refreshPickList(key, kind+"Pick", kind+"Search");
}

hookProfiles("shipper");
hookProfiles("consignee");

/* -----------------------------
   App Bootstrap
--------------------------------*/
function refreshAll(){
  renderBlueprint();
  renderBroker();
  refreshTripsUI();
  updateTripKPIsFromInputs();
  renderInvoicePreview();
}

(function init(){
  const saved=loadJSON(KEY_SETTINGS, structuredClone(DEFAULTS));
  // upgrade safety: merge missing fields if you change defaults later
  const merged=structuredClone(DEFAULTS);
  // shallow merge
  Object.assign(merged, saved);
  merged.household = Object.assign({}, DEFAULTS.household, saved.household||{});
  merged.business  = Object.assign({}, DEFAULTS.business,  saved.business||{});
  merged.pct       = Object.assign({}, DEFAULTS.pct,       saved.pct||{});
  merged.cap       = Object.assign({}, DEFAULTS.cap,       saved.cap||{});
  merged.afterCap  = Object.assign({}, DEFAULTS.afterCap,  saved.afterCap||{});
  merged.miles     = Object.assign({}, DEFAULTS.miles,     saved.miles||{});
  setSettings(merged);
  persistSettings();

  // ensure trips UI exists
  refreshTripsUI();
  updateTripKPIsFromInputs();
  renderInvoicePreview();
})();
</script>
</body>
</html>
